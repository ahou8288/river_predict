print("Importing libraries.")
from selenium import webdriver
from selenium.webdriver.support.ui import Select
import time

def print_log(message,priority):
	threshold=2
	if priority>=threshold:
		print(message)
def make_file(river_num):
	base_path="C:\\Users\\andrew\\Dropbox\\Uni assignments\\RiverDownload\\Downloaded Rivers"
	file_name=river_num+'_failed.txt'
	open(base_path+'\\'+file_name, 'a').close()
	print_log('failure file created',2)

def download_river(river_list):
	print_log("Starting the browser.",0)
	driver = webdriver.Chrome()
	driver.get("http://realtimedata.water.nsw.gov.au/water.stm")
	print_log("Loading the page.",0)
	time.sleep(5)
	for river_num in river_list:
		try:
			driver.switch_to_default_content()
			driver.switch_to.frame('webhyd')
			#pick a page
			driver.execute_script("javascript:go('%s','rs',1)" % river_num)
			time.sleep(1) #wait for it to load

			#switch to the custom download tab
			driver.execute_script("menuloc.display_frame('rs','rscf_org','1');")

			#leave the menu iframe and join the download selection iframe
			driver.switch_to.frame('rsrscf_org')
			time.sleep(1)
			print_log("Selecting download options.\nDownload output, daily interval, rainfall and stream water level.",0)

			print_log('output ',0)
			select_download = Select(driver.find_element_by_xpath("//select[@name='output']"))
			select_download.select_by_visible_text("Download")

			time.sleep(1)
			print_log('checkbox ',0)
			water_level_check=driver.find_element_by_xpath("//input[contains(@name,'Stream Water Level')]")
			if (not water_level_check.is_selected()):
				water_level_check.click()

			time.sleep(1)
			print_log('interval',0)
			select_interval = Select(driver.find_element_by_xpath("//select[@name='interval']"))
			select_interval.select_by_visible_text("Daily")

			#Clicking button
			print_log('Preparing download.',0)
			driver.execute_script("get_output();")

			print_log('Trying to download file',0)
			menu_iframe= driver.find_element_by_id("downloadlink").click()
			print_log('File is dowloading. Moving to next page',0)
		except Exception as e:
			print_log("An exception occured:",1)
			print_log(e,1)
			print_log("River number %s has not been sucessfully downloaded." % river_num,2)
			make_file(river_num)
	# driver.close()

# all_rivers=['201001','201005','201012']
all_rivers=['201001','201005','201012','201015','201900','202001','202002','203002','203004','203005','203010','203012','203014','203023','203024','203030','203034','203041','203042','203056','203057','203059','203060','203061','203062','203063','203403','203450','203470','203900','204001','204002','204004','204006','204007','204008','204014','204015','204017','204025','204030','204031','204033','204034','204036','204037','204039','204041','204043','204046','204051','204055','204056','204067','204068','204069','204071','204072','204073','204078','204400','204403','204413','204460','204900','204906','205002','205015','205016','205017','205018','205019','206001','206008','206009','206011','206014','206018','206024','206025','206026','206027','206032','206033','206034','206035','206036','206037','206038','206039','206042','206043','206044','206402','206460','207004','207006','207008','207009','207010','207013','207014','207015','207017','207018','208001','208003','208004','208005','208006','208007','208008','208009','208011','208015','208019','208020','208024','208026','208027','208028','208029','208030','208031','208032','208400','208410','208420','209002','209003','209006','209018','210001','210002','210004','210006','210010','210011','210014','210015','210016','210017','210018','210021','210022','210028','210031','210039','210040','210044','210052','210055','210056','210061','210064','210066','210070','210076','210079','210080','210083','210084','210089','210091','210093','210097','210102','210110','210114','210117','210118','210124','210126','210127','210128','210129','210130','210134','210135','210136','210137','210142','210143','210144','210146','210147','210149','210150','210151','210409','210410','210432','210448','210452','210455','210903','211008','211009','211010','211013','211014','211015','211017','212008','212011','212013','212018','212021','212040','212042','212045','212048','212049','212053','212054','212055','212058','212059','212060','212063','212064','212065','212066','212067','212068','21210100','21210101','21210102','21210103','21210104','21210105','21210106','21210107','21210108','21210109','21210110','212320','212406','212407','212460','212461','567069','568295','568296','213005','213006','213009','213011','213012','213013','213014','213018','214003','214010','215002','215004','215007','215008','215014','215016','215018','215019','215430','216002','216004','216009','217006','217007','218001','218005','218007','218008','219001','219003','219006','219013','219016','219017','219018','219022','219025','219027','219032','219033','219034','219063','219064','219065','219410','219900','220003','220004','221002','222004','222007','222008','222013','222016','222017','222019','222026','222027','401007','401008','401009','401012','401012','401013','401014','401014','401015','401016','401017','401024','401026','401027','401029','401204','401211','401224','401549','409001','409002','409003','409005','409006','409008','409013','409014','409016','409017','409019','409020','409021','409022','409023','409024','409025','409026','409029','409030','409035','409036','409037','409044','409045','409047','409048','409056','409061','409062','409075','409086','409098','409101','409107','409108','409109','409111','409113','409114','409202','409204','409216','072082','072169','073019','410001','41000200','41000207','41000208','41000209','41000210','41000212','41000213','41000236','41000240','41000244','41000254','41000255','41000256','41000260','41000261','41000263','41000269','41000270','41000271','41000272','41000275','41000279','41000280','41000281','41000282','41000283','410004','410005','410006','410007','410008','410012','410013','410014','410015','410016','410017','41001701','41001702','410021','410023','410024','410025','410026','410033','410036','410038','410039','410040','410041','410043','410044','410047','410048','410050','410057','410058','410059','410060','410061','410062','410068','410073','410076','410078','410081','410082','410088','410090','410091','410092','410093','410097','410102','41010287','410103','41010309','41010399','410106','410107','410108','41010810','41010904','41010922','41010928','41010941','41010966','41010969','41010970','41010971','41010981','410110','410112','410114','410128','410130','410131','410133','410134','410136','410137','410138','410141','410143','410148','410152','410155','410156','410160','410168','410169','410170','410173','410175','410176','410182','410183','410185','410186','410187','410190','410191','410195','410199','410700','410705','410730','410738','410747','410752','410756','410761','410770','410777','410851','572028','572031','573015','573016','411003','412002','41200208','41200209','41200210','412004','412005','412006','412008','412010','412011','412012','412014','412016','412017','412023','412024','412027','412029','412030','412033','412036','412038','412039','412042','412045','412046','412047','412048','412050','412056','412057','412065','412066','412067','412077','412078','412080','412100','412101','41210169','41210170','412102','412106','412107','412109','412122','412124','412129','412134','412139','412141','412150','412152','412154','412163','412172','412175','412177','412179','412180','412181','412183','412187','412188','412189','412190','412192','412194','412195','412196','412901','413001','413002','41310022','41310023','41310024','41310025','41310026','41310027','41310028','416001','416002','416003','416006','416007','416008','416010','416011','416012','416016','416020','416021','416022','416023','416027','416030','416031','416032','416037','416039','416040','416043','416046','416047','416048','416050','416052','416054','416055','416056','416057','416058','416059','416061','416062','416063','416064','416065','416066','416067','416068','416069','416072','416080','416315','417001','418001','418002','418004','418005','418008','418011','418012','418013','418014','418015','418017','418021','418025','418026','418027','418032','418035','418036','418037','418042','418043','418044','418047','418048','418049','418051','418052','418053','418055','418058','418059','418060','418061','418063','418065','418066','418067','418068','418070','418074','418076','418077','418078','418079','418083','418085','418086','418087','418089','418091','418092','419001','419003','419005','419006','419007','419009','419010','419011','419012','419015','419016','419020','419021','419022','419023','419024','419026','419027','419028','419029','419032','419033','419034','419035','419039','419039','419041','419043','419045','419049','419051','419053','419054','419056','419059','419060','419061','419062','419063','419064','419068','419069','419070','419073','419074','419076','419079','419080','419081','419083','419084','419085','419086','419088','419089','419090','419091','419093','419094','419095','419096','419097','419098','419099','419102','419103','419104','419105','419106','419107','419108','419109','419110','419111','419112','419900','419905','419906','420003','420004','420007','420017','420020','420022','420023','420901','421001','421003','421004','421005','421008','421011','421012','421014','421015','421016','421017','421018','421019','421022','421023','421026','421027','421031','421039','421040','421042','421048','421050','421051','421055','421076','421078','421079','421083','421088','421089','421090','421097','421107','421111','421116','421118','421127','421129','421132','421135','421138','421144','421145','421146','421147','421148','421149','421150','421151','421152','421153','421158','421164','421165','421166','421175','421176','421178','421184','421185','421186','421188','421189','421191','421192','421194','421195','421196','421197','421198','421900','422001','422002','422003','422004','422005','422006','422007','422010','422011','422013','422015','422016','422017','422018','422022','422023','422025','422026','422027','422028','422029','422030','422031','422032','422034','423001','423002','423004','423005','423008','424002','425001','425003','425004','425005','425007','425008','425010','425011','425012','425013','425014','425016','425018','425019','425020','425021','425022','425023','425034','425035','425036','425037','425038','425039','425044','425048','425049','425050','425052','425053','425054','425900']

#Check against downloaded files
from os import listdir
from os.path import isfile, join
mypath="C:\\Users\\andrew\\Dropbox\\Uni assignments\\RiverDownload\\Downloaded Rivers"
downloaded_rivers = [f.split('_')[0] for f in listdir(mypath) if isfile(join(mypath, f))]
not_downloaded=[river for river in all_rivers if river not in downloaded_rivers]

print(str(len(downloaded_rivers))+' rivers have been downloaded. %d rivers remaining.' %len(not_downloaded))

#split into chunks
num_threads=2
import numpy
chunks = [list(i) for i in numpy.array_split(numpy.array(not_downloaded),num_threads)]

from multiprocessing.dummy import Pool as ThreadPool
pool = ThreadPool(num_threads)
pool.map(download_river,chunks)

# Note; practice on this river, it has a failure
# download_river('416016')